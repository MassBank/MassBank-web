<IfModule mod_ssl.c>
	 <VirtualHost massbank.eu:443>
        	
		ServerName massbank.eu
                ServerAlias www.massbank.eu massbank.eu massbank.normandata.eu www.massbank.normandata.eu www.massbank.ufz.de massbank.ufz.de
                ServerAdmin massbank@massbank.eu
				
		SSLOptions +StrictRequire
		SSLProtocol -all +TLSv1.3 +TLSv1.2
	
		# settings based on recommendations from https://raymii.org/s/tutorials/Strong_SSL_Security_On_Apache2.html Gives only an A at sslabs.com !kDHE based 
		# on https://github.com/Balasys/dheater [CERT-Bund] CB-K21/1276 - TLS - possible vulnerability removes some backward compability to old windows 7/8 
		# IE11 and MAC / Safari combinations
		
		SSLCipherSuite EECDH+AESGCM:EDH+AESGCM:AES256+EECDH+RSA:AES256+EDH:!kDHE
		SSLOpenSSLConfCmd Curves X25519:secp521r1:secp384r1:prime256v1
		SSLHonorCipherOrder on
		SSLCompression off
		SSLSessionTickets off
			
		LogLevel warn ssl:warn
		
		# Privacy compliance https://github.com/DigitaleGesellschaft/Anonip ErrorLog ${APACHE_LOG_DIR}/error.log
		ErrorLog "|/opt/anonip/anonip.py --output ${APACHE_LOG_DIR}/error.log"
		#CustomLog ${APACHE_LOG_DIR}/access.log combined
		CustomLog "|/opt/anonip/anonip.py --output ${APACHE_LOG_DIR}/access.log" combined

		SSLEngine on
		# List certificates here
		SSLCertificateFile /etc/ssl/massbank.eu.crt
		SSLCertificateChainFile /etc/ssl/chain.crt
		SSLCertificateKeyFile /etc/ssl/massbank.eu.key
		Include /etc/letsencrypt/options-ssl-apache.conf
				
		# Port to link to Tomcat container
				
		Define TargetPort 8081
		
		# Rewrite conditions and rules
				
		RewriteEngine on
	
		# LogLevel info rewrite:trace2
		RewriteRule ^/MassBank$ /MassBank/ [R]
				
		RewriteCond %{HTTP_HOST} ^(www\.)massbank\.jp$ [NC,OR]
		RewriteCond %{HTTP_HOST} ^www\.massbank\.eu$ [NC,OR]
		RewriteCond %{HTTP_HOST} ^(www\.)massbank\.ufz\.de$ [NC]
		RewriteRule ^(.*)$ https://massbank.eu$1 [L,R=301]
		RewriteCond %{REQUEST_URI} ^\/MassBank\/index$ [NC,OR]
		RewriteCond %{REQUEST_URI} ^\/MassBank\/index\.jsp$ [NC,OR]
		RewriteCond %{REQUEST_URI} ^\/MassBank\/index\.html$ [NC]
		RewriteRule (.*) https://massbank.eu/MassBank [R=301,L]
		
		# RewriteCond %{REQUEST_URI} ^\/MassBank\/menu\.html$ [NC,OR]
		RewriteCond %{REQUEST_URI} ^\/MassBank\/menu\.jsp$ [NC]
		RewriteRule .* https://massbank.eu/MassBank [R=410,L]

		RewriteCond %{REQUEST_URI} ^/MassBank/jsp/Dispatcher\.jsp$
		RewriteCond %{QUERY_STRING} ^type=disp&(id=[0-9A-Z]+).*$
		RewriteRule (.*) https:/massbank.eu/MassBank/RecordDisplay?%1 [R=301,QSD]

		RewriteCond %{REQUEST_URI} ^/MassBank/RecordDisplay\.jsp$ [NC,OR]
		RewriteCond %{REQUEST_URI} ^/MassBank/jsp/RecordDisplay\.jsp$ [NC,OR]
		RewriteCond %{REQUEST_URI} ^/MassBank/jsp/FwdRecord\.jsp$
		RewriteCond %{QUERY_STRING} ^(id=[0-9A-Z]+).*$
		RewriteRule (.*) https://massbank.eu/MassBank/RecordDisplay?%1 [R=301,QSD]

		RewriteCond %{REQUEST_URI} ^\/MassBank\/RecordIndex$ [NC]
		RewriteRule .* https://massbank.eu/MassBank/Contents [R=301,QSD]

		# Answer some curious crawlers looking for some kind of backdoor
		RewriteCond %{REQUEST_URI} PHP [NC]
		RewriteRule (.*) - [L,R=404]

		RewriteCond %{REQUEST_URI} config [NC]
		RewriteRule (.*) - [L,R=404]

		RewriteCond %{REQUEST_URI} ^\/\/phpmyadmin$ [NC]
		RewriteRule (.*) - [L,R=404]
				
		# Redirect to current docker image
		RewriteRule ^/MassBank/(.*)$ http://localhost:${TargetPort}/MassBank/$1 [P]
		ProxyPassReverse /MassBank http://localhost:${TargetPort}/MassBank

        </VirtualHost>
</IfModule>
